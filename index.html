<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Glifos</title>
    <link rel="stylesheet" href="styles.css"> 
    
    <script src="https://cdn.jsdelivr.net/npm/opentype.js@1.3.4/dist/opentype.min.js"></script>
</head>
<body>

    <header>
        <h1>Cargador y Visualizador de Glifos de Tipograf√≠a</h1>
        <p>Sube un archivo .ttf, .otf, .woff o .woff2 para ver todos sus glifos.</p>
    </header>

    <main>
        <input type="file" id="fontFileInput" accept=".ttf, .otf, .woff, .woff2">
        <p id="message" class="hidden">Cargando glifos...</p>

        <div id="glyphDisplay" class="hidden">
            <div class="header-controls">
                <h2>Glifos Encontrados (<span id="glyphCount">0</span>)</h2>
                <button id="copyButton" onclick="copyGlyphsToClipboard()">üìã Copiar Glifos</button>
            </div>
            
            <div id="glyphGrid">
                </div>
        </div>
    </main>

    <script>
        document.getElementById('fontFileInput').addEventListener('change', handleFontUpload);

        // Nombre de familia que usaremos temporalmente para la fuente cargada
        const FONT_FAMILY_NAME = 'user-uploaded-font'; 
        // Array global para almacenar los caracteres (glifos con Unicode)
        let visibleGlyphs = []; 

        /**
         * Maneja la carga del archivo, inyecta la fuente y muestra los glifos.
         */
        function handleFontUpload(event) {
            const fontFile = event.target.files[0];
            if (!fontFile) return;

            const message = document.getElementById('message');
            const glyphDisplay = document.getElementById('glyphDisplay');
            const glyphGrid = document.getElementById('glyphGrid');
            const glyphCount = document.getElementById('glyphCount');
            
            // Ocultar resultados anteriores y mostrar mensaje de carga
            glyphDisplay.classList.add('hidden');
            message.textContent = "Cargando glifos...";
            message.classList.remove('hidden');
            glyphGrid.innerHTML = ''; // Limpiar cuadr√≠cula
            glyphCount.textContent = '0';
            visibleGlyphs = []; // Limpiar array de glifos

            const reader = new FileReader();

            reader.onload = function(e) {
                const fontUrl = e.target.result;
                
                injectFontFace(fontUrl);
                displayGlyphs(fontUrl, message, glyphDisplay, glyphGrid, glyphCount);
            };

            reader.readAsDataURL(fontFile);
        }

        function injectFontFace(fontUrl) {
            let style = document.getElementById('customFontStyles');
            if (!style) {
                style = document.createElement('style');
                style.id = 'customFontStyles';
                document.head.appendChild(style);
            }
            
            style.innerHTML = `
                @font-face {
                    font-family: '${FONT_FAMILY_NAME}';
                    src: url('${fontUrl}') format('truetype'), 
                         url('${fontUrl}') format('opentype'),
                         url('${fontUrl}') format('woff'),
                         url('${fontUrl}') format('woff2');
                }
            `;
        }

        /**
         * Analiza la fuente y renderiza los glifos, guard√°ndolos en el array global.
         */
        function displayGlyphs(fontUrl, message, glyphDisplay, glyphGrid, glyphCount) {
            opentype.load(fontUrl, function(err, font) {
                message.classList.add('hidden');
                
                if (err) {
                    message.textContent = 'Error al cargar o analizar la fuente: ' + err;
                    message.classList.remove('hidden');
                    return;
                }

                const totalGlyphs = font.glyphs.length;
                glyphCount.textContent = totalGlyphs;

                for (let i = 0; i < totalGlyphs; i++) {
                    const glyph = font.glyphs.get(i);
                    const charCode = glyph.unicode;
                    let char = '';
                    let titleText = `ID: ${glyph.index}`;

                    if (charCode) {
                        char = String.fromCharCode(charCode);
                        titleText += ` | Unicode: U+${charCode.toString(16).toUpperCase()}`;
                        // ‚≠êÔ∏è ALMACENAR CARACTERES VISIBLES (solo los que tienen Unicode)
                        visibleGlyphs.push(char);
                    } else {
                        char = ' '; 
                        titleText += ' | No tiene Unicode asociado';
                    }

                    const glyphElement = document.createElement('span');
                    glyphElement.className = 'glyph-item';
                    
                    const charDisplay = document.createElement('div');
                    charDisplay.className = 'char-display';
                    charDisplay.textContent = char;
                    charDisplay.style.fontFamily = FONT_FAMILY_NAME;
                    
                    const infoDisplay = document.createElement('div');
                    infoDisplay.className = 'info-display';
                    infoDisplay.textContent = titleText;
                    
                    glyphElement.appendChild(charDisplay);
                    glyphElement.appendChild(infoDisplay);
                    
                    glyphGrid.appendChild(glyphElement);
                }

                glyphDisplay.classList.remove('hidden');
            });
        }

        // --- FUNCI√ìN DE COPIADO AL PORTAPAPELES ---

        /**
         * Copia todos los glifos visibles (caracteres Unicode) al portapapeles.
         */
        function copyGlyphsToClipboard() {
            const button = document.getElementById('copyButton');
            // Unir todos los caracteres del array en una sola cadena sin separador.
            const textToCopy = visibleGlyphs.join(''); 
            
            if (textToCopy.length === 0) {
                alert('No hay glifos cargados para copiar.');
                return;
            }

            // Usamos la API del Portapapeles (Clipboard API), moderna y as√≠ncrona.
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    // Feedback visual al usuario
                    button.textContent = '‚úÖ ¬°Copiado!';
                    button.disabled = true;
                    setTimeout(() => {
                        button.textContent = 'üìã Copiar Glifos';
                        button.disabled = false;
                    }, 2000);
                })
                .catch(err => {
                    console.error('Error al copiar:', err);
                    alert('Error al copiar al portapapeles. Aseg√∫rate de que el navegador lo permite.');
                });
        }
    </script>
</body>
</html>
