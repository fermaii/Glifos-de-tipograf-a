<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Glifos</title>
    <link rel="stylesheet" href="styles.css"> 
    
    <script src="https://cdn.jsdelivr.net/npm/opentype.js@1.3.4/dist/opentype.min.js"></script>
</head>
<body>

    <header>
        <h1>Cargador y Visualizador de Glifos de TipografÃ­a</h1>
        <p>Sube un archivo .ttf, .otf, .woff o .woff2 para ver todos sus glifos.</p>
    </header>

    <main>
        <input type="file" id="fontFileInput" accept=".ttf, .otf, .woff, .woff2">
        <p id="message" class="hidden">Cargando glifos...</p>

        <div id="glyphDisplay" class="hidden">
            <div class="header-controls">
                <h2>Glifos Encontrados (<span id="glyphCount">0</span>)</h2>
                <button id="copyButton" onclick="copyGlyphsToClipboard()">ðŸ“‹ Copiar Caracteres</button>
            </div>
            
            <div id="glyphGrid">
                </div>
        </div>
    </main>

    <script>
        document.getElementById('fontFileInput').addEventListener('change', handleFontUpload);

        const FONT_FAMILY_NAME = 'user-uploaded-font'; 
        // Array global para almacenar los caracteres (solo glifos que tienen Unicode asociado)
        let visibleGlyphs = []; 

        function handleFontUpload(event) {
            const fontFile = event.target.files[0];
            if (!fontFile) return;

            const message = document.getElementById('message');
            const glyphDisplay = document.getElementById('glyphDisplay');
            const glyphGrid = document.getElementById('glyphGrid');
            const glyphCount = document.getElementById('glyphCount');
            
            glyphDisplay.classList.add('hidden');
            message.textContent = "Cargando glifos...";
            message.classList.remove('hidden');
            glyphGrid.innerHTML = '';
            glyphCount.textContent = '0';
            visibleGlyphs = [];

            const reader = new FileReader();

            reader.onload = function(e) {
                const fontUrl = e.target.result;
                
                injectFontFace(fontUrl);
                displayGlyphs(fontUrl, message, glyphDisplay, glyphGrid, glyphCount);
            };

            reader.readAsDataURL(fontFile);
        }

        function injectFontFace(fontUrl) {
            let style = document.getElementById('customFontStyles');
            if (!style) {
                style = document.createElement('style');
                style.id = 'customFontStyles';
                document.head.appendChild(style);
            }
            
            style.innerHTML = `
                @font-face {
                    font-family: '${FONT_FAMILY_NAME}';
                    src: url('${fontUrl}') format('truetype'), 
                         url('${fontUrl}') format('opentype'),
                         url('${fontUrl}') format('woff'),
                         url('${fontUrl}') format('woff2');
                }
            `;
        }

        /**
         * Analiza la fuente y renderiza los glifos usando Canvas.
         */
        function displayGlyphs(fontUrl, message, glyphDisplay, glyphGrid, glyphCount) {
            // Establecer un tamaÃ±o de canvas fijo
            const CANVAS_SIZE = 80;
            
            opentype.load(fontUrl, function(err, font) {
                message.classList.add('hidden');
                
                if (err) {
                    message.textContent = 'Error al cargar o analizar la fuente: ' + err;
                    message.classList.remove('hidden');
                    return;
                }

                const totalGlyphs = font.glyphs.length;
                glyphCount.textContent = totalGlyphs;

                for (let i = 0; i < totalGlyphs; i++) {
                    const glyph = font.glyphs.get(i);
                    const charCode = glyph.unicode;
                    let char = '';
                    let titleText = `ID: ${glyph.index}`;

                    if (charCode) {
                        char = String.fromCharCode(charCode);
                        titleText += ` | Unicode: U+${charCode.toString(16).toUpperCase()}`;
                        // Almacenar solo caracteres Unicode vÃ¡lidos para copiar
                        visibleGlyphs.push(char); 
                    } else {
                        char = ' '; 
                        titleText += ' | Sin Unicode';
                    }

                    const glyphElement = document.createElement('span');
                    glyphElement.className = 'glyph-item';
                    
                    // USAR CANVAS PARA DIBUJAR LA FORMA VECTORIAL DEL GLIFO
                    const charDisplay = document.createElement('canvas');
                    charDisplay.className = 'char-display';
                    charDisplay.width = CANVAS_SIZE;
                    charDisplay.height = CANVAS_SIZE;
                    
                    const ctx = charDisplay.getContext('2d');
                    
                    const scaleFactor = 0.8;
                    const fontSize = CANVAS_SIZE * scaleFactor;
                    
                    ctx.fillStyle = '#2c3e50'; 
                    
                    // Dibujar el glifo: ajustamos la Y para que estÃ© centrado visualmente
                    glyph.draw(ctx, 
                               CANVAS_SIZE * 0.1, 
                               CANVAS_SIZE * 0.8, 
                               fontSize);

                    // Contenedor para el detalle (ID/Unicode)
                    const infoDisplay = document.createElement('div');
                    infoDisplay.className = 'info-display';
                    infoDisplay.textContent = titleText;
                    
                    // Si tiene Unicode, mostramos el carÃ¡cter Unicode debajo del glifo dibujado
                    if (charCode) {
                        const unicodeLabel = document.createElement('div');
                        unicodeLabel.className = 'unicode-label';
                        unicodeLabel.textContent = char;
                        glyphElement.appendChild(unicodeLabel);
                    }

                    glyphElement.appendChild(charDisplay);
                    glyphElement.appendChild(infoDisplay);
                    glyphGrid.appendChild(glyphElement);
                }

                glyphDisplay.classList.remove('hidden');
            });
        }

        // --- FUNCIÃ“N DE COPIADO AL PORTAPAPELES ---

        function copyGlyphsToClipboard() {
            const button = document.getElementById('copyButton');
            // Unir todos los caracteres visibles en una sola cadena.
            const textToCopy = visibleGlyphs.join(''); 
            
            if (textToCopy.length === 0) {
                alert('No hay glifos cargados para copiar.');
                return;
            }

            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    // Feedback visual al usuario
                    button.textContent = 'âœ… Â¡Copiado!';
                    button.disabled = true;
                    setTimeout(() => {
                        button.textContent = 'ðŸ“‹ Copiar Caracteres';
                        button.disabled = false;
                    }, 2000);
                })
                .catch(err => {
                    console.error('Error al copiar:', err);
                    alert('Error al copiar al portapapeles. (Requiere HTTPS o servidor local)');
                });
        }
    </script>
</body>
</html>
